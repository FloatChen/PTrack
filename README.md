# PTrack

Off-Line Lagrangian Particle Tracking

# About

The particle tracking model this program implements (*PTrack*) was originally developed as a module embedded in the Unstructured Grid Finite Volume Community Ocean Model (*FVCOM*), first developed by Dr. Changsheng Chen et al. at the University of Massachusetts - Dartmouth. The current iteration of the particle tracking code found here is an almost complete rewrite of this module, designed to run independently of *FVCOM*. Presently *FVCOM* is being developed and maintained by the UMASSD Marine Ecosystem Dynamics Modelling Laboratory (MEDML), and more information may be found on their website: http://fvcom.smast.umassd.edu/

# Running the model

PTrack requires the creation of three different configuration and data files.

* Model configuration file (text)
* Particle seed file (NetCDF)
* Tidal forcing and model domain file (NetCDF)

The tidal forcing file contains the flow-field data to drives the movement of the particles being simulated, as well as the data needed to reconstruct the physical domain (mesh, bathymetry, etc.), and is produced as the primary output of *FVCOM*. The structure and content of the text files will be elaborated on in the following sections. After compiling the input, the model may be run from the command-line using the start-up script:

```sh
start_tracking.sh run.dat
```

Where *run.dat* is the model configuration file.

## Configuration file

 Parameter  | Units     | Description
 ---------- | --------- | -----------
 DTI        | seconds   | Simulation time step
 DTOUT      | seconds   | Output interval
 F_DEPTH    | boolean   | Hold particle depth constant
 P_REL_B    | boolean   | Particle positions relative to sea floor, not sea surface
 OUT_SIGMA  | boolean   | Output particle z position as sigma depth instead of meters
 GRIDFN     | file path | NetCDF grid and flow-field file location
 OUTFN      | file path | Output file location
 STARTSEED  | file path | Particle initial position (seed) file location
 P_RND_WALK | boolean   | Apply random walk behaviour to the active particles
 K_XY       | m^2/s     | Horizontal particle diffusivity (used when P_RND_WALK is **T**)
 K_Z        | m^2/s     | Vertical particle diffusivity (used when P_RND_WALK is **T**)

## Grid and Flow-field file

The NetCDF flow-field used to drive the particle tracking simulation is produced by *FVCOM*. While the grid portion of the flow-field may contain either Cartesian or Spherical coordinates, the particle tracking program requires Cartesian coordinates. If only Spherical coordinates are present the *fixproj* program may be used to apply a cartographic projection to the coordinates, in order to generate the necessary Cartesian coordinates. *fixproj* is automatically run by the start_tracking.sh script.

Normally this file will be automatically generated by *FVCOM*, and the user will not need to worry about its structure. The variables used by the particle tracking program are listed in the following table.

 Variable | Type  | Dimensions         | Units  | Description
 -------- | ----- | ------------------ | ------ | -----------
 time     | float | time               | MJD    | Days since 1858-11-17 00:00:00
 zeta     | float | time, node         | meters | Water surface elevation (upward positive)
 u        | float | time, siglay, nele | m/s    | Eastward water velocity
 v        | float | time, siglay, nele | m/s    | Northward water velocity
 ww       | float | time, siglay, nele | m/s    | Upward water velocity
 x        | float | node               | meters | Node x coordinate
 y        | float | node               | meters | Node y coordinate
 xc       | float | nele               | meters | Element x coordinate
 yc       | float | nele               | meters | Element y coordinate
 h        | float | node               | meters | Sea floor depth (downward positive)
 nv       | int   | three, nele        | none   | Nodes surrounding each element
 nbe      | int   | three, nele        | none   | Elements surrounding each element
 ntve     | int   | node               | none   | Number of elements surrounding each node
 nbve     | int   | maxelem, node      | none   | Elements surrounding each node
 siglev   | float | siglev, node       | none   | Sigma levels (boundary between layers)
 siglay   | float | siglay, node       | none   | Centre of the sigma layer
 a1u      | float | four, nele         | none   | Shape coefficient array and control volume metrics
 a2u      | float | four, nele         | none   | Shape coefficient array and control volume metrics
 aw0      | float | three, nele        | none   | Shape coefficient array and control volume metrics
 awx      | float | three, nele        | none   | Shape coefficient array and control volume metrics
 awy      | float | three, nele        | none   | Shape coefficient array and control volume metrics

To ensure all of the required variables are present in the file, the following options should be enabled in the *casename_run.nml* configuration file for the *FVCOM* run.

* Configuration section: `NML_NETCDF`
* `NC_GRID_METRICS = T`
* `NC_VELOCITY = T`
* `NC_VERTICAL_VEL = T`

### *fixproj*

The *fixproj* program is designed to take geographic coordinate variables, transform the coordinates according to a given cartographic projection, and then save the results back to the NetCDF file. By default the program will use **lon**/**lat** as the names for spherical coordinates, and **x**/**y** as the names for Cartesian coordinate variables. The default behaviour is to do a forward (Spherical to Cartesian) projection. The syntax for running *fixproj* is as follows:

```sh
fixproj [-p projection] [-i] [-v lon lat x y] file_to_process.nc
```

Command arguments:

* `v` - Use alternate coordinate variable names (optional)
* `i` - Perform an inverse projection (Cartesian to Spherical) (optional)
* `p` - Provide a PROJ.4 compatible projection reference (optional)

If a projection reference is not provided, *fixproj* will attempt to use the NetCDF file's **CoordinateProjection** global attribute. If the attribute does not contain a valid projection reference the program will fail. If a projection reference is provided via the command line, the program will save the reference back to this global attribute; as the Cartesian coordinates are effectively meaningless without a way to reference them back to a known point on the globe.
If the `-i` argument is not used, the program will perform a regular (Spherical to Cartesian) cartographic projection.
The `-v` argument provides a way to specify alternate names for the coordinate variables, in the order: longitude, latitude, x, and y.

## Particle seed file

The particle seed file contains the initial positions of all particles to be released in the simulation, in addition to the release timing. This file is stored in NetCDF format, and the variables used are listed in the following table.

 Variable | Type  | Dimensions | Units  | Description
 -------- | ----- | ---------- | ------ | -----------
 number   | int   | number     | none   | Arbitrary identifier
 x        | float | number     | meters | Domain x coordinate
 y        | float | number     | meters | Domain y coordinate
 z        | float | number     | meters | Downward positive particle depth
 release  | float | number     | MJD    | Time to release particle into the simulation
 end      | float | number     | MJD    | Time to remove particle from the simulation

### *genseed*

The *genseed* program may be used to generate the particle seed file from a text-based *.dat* file, and allows for some flexibility with the format of the input data. The syntax for using *genseed* is as follows:

```sh
genseed [-o outfile.nc] [-t] [-p projection] particle_release.dat
```

Command arguments:

* `p` - Specify a projection reference (optional)
* `t` - Use yyyy-mm-dd hh:mm:ss date formatting (optional)
* `o` - Specify an output file name (optional)

If a projection reference is not provided, it is assumed that the particle coordinates are already Cartesian. Note: the projection reference used for the seed file **must** match the reference used for the NetCDF flow-field file, otherwise the simulation results will be meaningless.
The `-t` argument tells *genseed* to read the release and track end times as date strings (yyyy-mm-dd hh:mm:ss). If the option is not used it will be assumed that the times are Modified Julian Dates (days since 1858-11-17 00:00:00).
If an output file name is not provided, the file will have the same name as the input file except with a *.nc* file extension instead of *.dat*.

Each line of the file defines a different hypothetical seed particle, with the parameters separated by one or more spaces. The order of the parameters, along with their meaning, is given in the following table:

 Column | Name           | Type  | Units                        | Description
 ------ | -------------- | ----- | ---------------------------- | -----------
 1      | ID             | int   | none                         | Arbitrary identifier
 2      | X              | float | meters *or* degrees_east     | Domain x coordinate
 3      | Y              | float | meters *or* degrees_north    | Domain y coordinate
 4      | Z              | float | meters                       | Downward positive particle depth
 5      | Release Time   | float | MJD *or* yyyy-mm-dd hh:mm:ss | Time to release particle into the simulation
 6      | Track End Time | float | MJD *or* yyyy-mm-dd hh:mm:ss | Time to remove particle from the simulation

## Simulation output

The simulation output file contains all of the results from the simulation, and is also a NetCDF file. The variables this file contains are listed in the following table.

 Variable | Type  | Dimensions   | Units  | Description
 -------- | ----- | ------------ | ------ | -----------
 time     | float | time         | MJD    | Time the particle position was recorded
 number   | int   | number       | none   | Arbitrary identifier
 x        | float | time, number | meters | Domain x coordinate
 y        | float | time, number | meters | Domain y coordinate
 z        | float | time, number | meters | Downward positive particle depth

